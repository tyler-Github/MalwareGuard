import os
import shutil
import PySimpleGUI as sg

# Define the layout for the UI
layout = [
    [sg.Text('Click the button to update MalwareGuard')],
    [sg.Button('Update')],
    [sg.Output(size=(50, 10))]
]

# Create the UI window
window = sg.Window('MalwareGuard Updater', layout)

# Run the event loop
while True:
    event, values = window.read()
    if event == sg.WIN_CLOSED:
        break
    elif event == 'Update':
        try:
            # Navigate to the directory containing the update script
            script_dir = os.path.dirname(os.path.abspath(__file__))
            os.chdir(script_dir)

            # Delete the MalwareGuard folder if it already exists
            malwaredir = os.path.join(script_dir, 'MalwareGuard')
            if os.path.isdir(malwaredir):
                shutil.rmtree(malwaredir)

            # Clone the MalwareGuard repository from GitHub
            os.system('git clone https://github.com/tyler-Github/MalwareGuard.git')

            # Remove all files in the main directory except for update.py
            for filename in os.listdir(script_dir):
                try:
                    if filename != 'update.py':
                        os.remove(os.path.join(script_dir, filename))
                    if filename != 'update.bat':
                        os.remove(os.path.join(script_dir, filename))
                except PermissionError:
                    print(f"Skipping file {filename}: insufficient permissions")

            # Move all files from the cloned repository to the main directory
            for filename in os.listdir(malwaredir):
                src = os.path.join(malwaredir, filename)
                dst = os.path.join(script_dir, filename)
                try:
                    if os.path.exists(dst):
                        if os.path.isdir(dst):
                            shutil.rmtree(dst)
                        else:
                            os.remove(dst)
                    os.rename(src, dst)
                except PermissionError:
                    print(f"Skipping file {filename}: insufficient permissions")
                except Exception as e:
                    print(f"An error occurred while moving {filename}: {str(e)}")

            # Delete the cloned repository
            shutil.rmtree(malwaredir)

            # Print a success message to the UI
            print('MalwareGuard has been updated successfully!')
        except Exception as e:
            # Print an error message to the UI if the update fails
            print('An error occurred while updating MalwareGuard:')
            print(str(e))

# Close the UI window when the event loop is finished
window.close()
